<!doctype html>

<html>

<head>

    <title>Capture The Campus</title>
    <link rel="icon" href="images/CaptureTheFlagLogo2.ico">
    <script type="text/javascript" src="js/PlayerObject.js"></script>
    <script type="text/javascript" src="js/TeamObject.js"></script>
    <script type="text/javascript" src="js/CapturePointObject.js"></script>
    <style>
        #map { height: 75vh; }

        .button{
          height: 10vh;
          width: 40vw;
}

.leaflet-tooltip.redteam {
  background-color: transparent;
  border: transparent;
  box-shadow: none;
  font-weight: bold;
  font-size: 20px;
  font-family:'Copperplate Gothic','Times New Roman', Times, serif;
  color: red;
  }
  .leaflet-tooltip.blueteam {
  background-color: transparent;
  border: transparent;
  box-shadow: none;
  font-weight: bold;
  font-size: 20px;
  font-family:'Copperplate Gothic','Times New Roman', Times, serif;
  color: blue;
  }

  .leaflet-tooltip.capture {
  background-color: rgba(0, 0, 0, 0.637);
  border: transparent;
  box-shadow: none;
  font-weight: bold;
  font-size: 15px;
  font-family:'Copperplate Gothic','Times New Roman', Times, serif;
  color: rgb(0, 255, 234);
  }

    </style>

<link rel="stylesheet" href="leaflet/leaflet.css"/>

<script src="leaflet/leaflet.js"></script>

</head>

<body style="background-color:rgb(0, 0, 0);">

    <h1 style="text-align:center;">Capture The Campus</h1>

    





    <!--  Main Site, to contain a welcome screen with an explination on how to play-->
    <div id="mainpage" style="background-color:rgb(0, 0, 0);border: 5px solid #000000 ">
      <input type="button" class="button" value="RedTeam" onclick="setredteam()">
      <input type="button" class="button" value="BlueTeam" onclick="setblueteam()">
       
        <p id="demo" style="background-color:rgb(255, 255, 255);border: 5px solid #000000 "></p>


    </div>
    <!-- End Of Main Site -->

    <div id="map"></div>


</body>
 
<script>
    
    var map;
    

    

    var x = document.getElementById("demo");

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    
    function setLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPositionmap);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    function showPositionmap(position) {
      

      map = L.map('map').setView([position.coords.latitude, position.coords.longitude], 19);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
      
      }

    setLocation();
    


    var users = [];
    //create js objects to hold the marker, and other player info, this can then be used(with a check loop) to see if the 
    //player is still online, and so that the player can be moved

    var teams = [];
    var capturepoints = [];

//run every 1000 ms
//game loop 
setInterval(GameLoop, 1000);

var userid;
var username;
//var userlocation;
var userlocationlatitude;
var userlocationlongitude;
//[position.coords.latitude, position.coords.longitude]

var userteam = 0;

var newusertimeout = 6;



function GameLoop() {


  //first do the local player stuff
  if(1 == 1){

      //first fetch the local players location
      getLocation2();
      
      if(userid == null){
        //check for a cookie
        if(userteam != 0){
          var returncookieuserid = "";// = getCookie("userid");

          if(returncookieuserid == ""){
            //then send a load command to the server to get a user id and a player name
            if(newusertimeout > 5){
              loadnewuser();
              newusertimeout = 0;
            }
            newusertimeout++;
          
          }
          else{
            userid = returncookieuserid;
            username = "Player" . returncookieuserid;
          }
        }

        //the id and username should now be set either by the cookie or by getting a new userid

      }
      else{

        //if the user id isn't null then the local player can sent the id and location, to the server in order to update them on the server side
        setuserlocation();

        //setuserteam();

      }


  }
  

  //then do the external stuff
  //load the players onto the map
  //
  if(userteam != 0){
    

    //set a check for each user, so that it can be seen as offline if not updated
    users.forEach(user => {
      user.setcheck();
    });


    
    
    
    //get all the users and their locations, then load them onto the map
    


     loadgameinfo();




//remove all the users from the map that are not on the location list

     users.forEach(user => {
      if(user.getcheck() >= 5){
         user.hideplayer(map);
      }
     
    });
  }

}





function loadgameinfo() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {loadgameinforeturn(this);}
  xhttp.open("GET", 'https://uniserver.ethanrws.com/getgameinfo.php');
  xhttp.send();
}

function loadgameinforeturn(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

      var lines = response.split(/\r?\n|\r|\n/g);
      //console.log(lines);    

      //used when loading the lines, to determine what is been loaded
      //and therefore where does the data need to go
      var linetype = 0;
             
      if(lines[0] != ""){

          for (i = 0; i < lines.length; i++) {
            var linetypechange = 0;
            if(lines[i] == "###teams"){
              //console.log(lines[i]);  
              //then set it to teams mode,
              //and continue until another modechange occurs
              linetype = 1;
              linetypechange = 1;
            }
            if(lines[i] == "###capturepoints"){
              //console.log(lines[i]);
              //then set it to capturepoints mode,
              //and continue until another modechange occurs
              linetype = 2;
              linetypechange = 1;
            }
            if(lines[i] == "###players"){
              //console.log(lines[i]);
              //then set it to players mode,
              //and continue until the end of the lines
              linetype = 3;
              linetypechange = 1;
            }

            //team mode
            if(linetype == 1 && linetypechange == 0){

              var line = lines[i].split('|');
              //console.log(lines[i]);
              var id = line[0];
              var teamname = line[1];
              var teamscore = line[2];
              var teamcapcount = line[3];

              var teamalreadyloaded = 0;

              if(teams.length != 0){

              
                teams.forEach(team => {
  
                  if(team.getid() == id){
                    teamalreadyloaded = 1;

                    team.setteamscore(teamscore);
                    team.setteamcapcount(teamcapcount);
                  }
                });

              }
  
              if(teamalreadyloaded == 0){
                var newteam = new TeamObject(id,teamname,teamscore,teamcapcount);
                teams.push(newteam);
              } 


            }

            //capture points mode
            if(linetype == 2 && linetypechange == 0){

              var line = lines[i].split('|');
              //console.log(lines[i]);
              var id = line[0];
              var capturepointname = line[1];

              var locationlat = line[2];
              var locationlong = line[3];

              var capturedteam = line[4];
              var capturedteamvalue = line[5];
              var radius = line[6];

              var capturepointalreadyloaded = 0;

              if(capturepoints.length != 0){
              capturepoints.forEach(capturepoint => {

                if(capturepoint.getid() == id){
                  capturepointalreadyloaded = 1;
                  //here will be where the map ref, and lat, long are passed
                  capturepoint.setcapturedteam(capturedteam);
                  capturepoint.setcapturedteamvalue(capturedteamvalue);
                  capturepoint.updateview();

                }
              });
            }

              if(capturepointalreadyloaded == 0){
                var newcapturepoint = new CapturePointObject(id,capturepointname,teamscore,teamcapcount,radius,map,locationlat,locationlong);
                capturepoints.push(newcapturepoint);
              } 


            }

            //player mode
            if(linetype == 3 && linetypechange == 0){

            
             var line = lines[i].split('|');
             //console.log(line);
             //console.log(lines[i]);
             var id = line[0];
             var playername = line[1];
             var locationlat = line[2];
             var locationlong = line[3];
             var playerteam = line[4];
             var playerhealth = line[5];
             var playerclass = line[6];

            //add health,(have a ghost mode
            //that shows other players as ghosts,)

            //also have the localplayer have a golden halo effect to 
            //show that it is the local player

             var playeralreadyloaded = 0;

            
             if(users.length != 0){
             users.forEach(user => {
               
                if(user.getid() == id){
                  playeralreadyloaded = 1;
                  user.resetcheck();
                  user.setlocation(map, locationlat,locationlong);
                  user.setteam(playerteam);

                  user.sethealth(playerhealth);
                  user.setclass(playerclass);
                  
                }
          
              });
            }
               

              if(playeralreadyloaded == 0){

                var newuser = new PlayerObject(id,playername);

               
                newuser.setid(id);
                newuser.setplayername(playername);
                newuser.setlocation(map, locationlat,locationlong);
                newuser.setteam(playerteam);
                newuser.sethealth(playerhealth);
                newuser.setclass(playerclass);
                newuser.setcheck(1);
                if(id == userid){
                      //then this is the local player
                      newuser.setlocalplayer(true);
                }

                users.push(newuser);
                
                
            }


            }



           }
       }
				
	}




function loadnewuser() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {loadnewuserreturn(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/createplayer.php?latitude=' + 0 + '&longitude=' + 0 +'');
  xhttp.send();
}

function loadnewuserreturn(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

      var lines = response.split(/\r?\n|\r|\n/g);
               // var lines = response.match(/[^\r\n]+/g);

               //console.log(lines[0]);
              if(lines[0] == "ok"){
                  userid = lines[1];
                 username = lines[2];

                 //console.log("userid:" + userid);
                 //console.log("username:" + username);


                // setCookie("userid", userid, 365);
              }
              
				/*
      for (i = 0; i < lines.length; i++) {
      }
				*/	
	}


  function setuserlocation() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {setuserlocationreturn(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/updatelocation.php?id=' + userid + '&latitude=' + userlocationlatitude + '&longitude=' + userlocationlongitude +'');
  xhttp.send();
}

function setuserlocationreturn(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

	}


  function getLocation2() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition2);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    
    function showPosition2(position) {
      
      userlocationlatitude = position.coords.latitude;
      userlocationlongitude = position.coords.longitude;
        //console.log(userlocation);
    }


function setredteam(){
  if(userteam == 0){
    userteam = 1;
    setuserteam();
  } 
}
function setblueteam(){
  if(userteam == 0){
    userteam = 2;
    setuserteam();
  }
}


    function setuserteam() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {setuserteam2(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/updateteam.php?id=' + userid + '&team=' + userteam +'');
  xhttp.send();
}

function setuserteam2(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

	}







</script>


</html>