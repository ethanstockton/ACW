<!doctype html>

<html>

<head>

    <title>Capture The Campus</title>
    <link rel="icon" href="images/CaptureTheFlagLogo2.ico">
    <script type="text/javascript" src="js/PlayerObject.js"></script>
    <script type="text/javascript" src="js/TeamObject.js"></script>
    <script type="text/javascript" src="js/CapturePointObject.js"></script>
    <style>

html {
  overflow: hidden;
  width: 99%;
}

body {
  height: 99%;
  width: 99%;
  position: fixed;
  /*overflow-y: scroll;*/
  -webkit-overflow-scrolling: touch;
  
}

.startmenu {
  
      position: fixed;
      background: rgb(78, 78, 78);
      
      z-index: 99999;
      height: 100vh;
      width: 100vw;
      top: 100%; 
      
      left: 0%;

      transform: rotate(0deg) translateX(0px) translateY(-100%); 
      transform-origin: 100% 0px;

      opacity: 1;
      text-align:center
    }

    .loadingscreen {
  
  position: fixed;
  background: rgb(78, 78, 78);
  
  z-index: 99998;
  height: 100vh;
  width: 100vw;
  top: 100%; 
  
  left: 0%;

  transform: rotate(0deg) translateX(0px) translateY(-100%); 
  transform-origin: 100% 0px;

  opacity: 1;
  text-align:center
}

    .button2{

      
			text-align: center;
			float: center;
			vertical-align: center;
			z-index: 1;
      
          height: 20vh;
          width: 20vw;
}

.center {
   position: absolute;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
    width: 90%;
   font-size:5vw;
   text-align: center;
	
}

.lower1 {
   position: absolute;
   vertical-align: center;
   bottom: 15%;
   left: 10%;
   right: 10%;
   
    width: 80%;
    min-height: 5vh;
    max-height: 5vh;
   font-size:5vw;
   text-align: center;
	
}


        #map { height: 85vh; }

        .button{
          min-height: 5vh;
          max-height: 5vh;
          width: 40vw;
        }

        .button3{
          height: 10vh;
          
          width: 40vw;
        }

        .button4{
          
          padding-top: 2vh;
          padding-bottom: 1vh;
        }

.row {
  display: flex;
  width: 100vw;
}

.column {
  flex: 50%;
  height: 0vh;
  padding-bottom: 5vh;
  
}


  .row2 {
  display: flex;
  /*height: 70vh;*/
  padding-top: 5vh;
  padding-bottom: 5vh;
  width: 100vw;
}

.column2 {
  flex: 50%;
  height: 0vh;
  padding-top: 5vh;
  padding-bottom: 10vh;
  
}


.leaflet-tooltip.redteam {
  background-color: transparent;
  border: transparent;
  box-shadow: none;
  font-weight: bold;
  font-size: 20px;
  font-family:'Copperplate Gothic','Times New Roman', Times, serif;
  color: red;
  }
  .leaflet-tooltip.blueteam {
  background-color: transparent;
  border: transparent;
  box-shadow: none;
  font-weight: bold;
  font-size: 20px;
  font-family:'Copperplate Gothic','Times New Roman', Times, serif;
  color: blue;
  }

  .leaflet-tooltip.capture {
  background-color: rgba(0, 0, 0, 0.637);
  border: transparent;
  box-shadow: none;
  font-weight: bold;
  font-size: 15px;
  font-family:'Copperplate Gothic','Times New Roman', Times, serif;
  color: rgb(0, 255, 234);
  }

    </style>

<link rel="stylesheet" href="leaflet/leaflet.css"/>

<script src="leaflet/leaflet.js"></script>

</head>

<body style="background-color:rgb(0, 0, 0);">

    <h1 style="color:rgb(255, 255, 255);text-align:center;line-height: 0.2em;width:100%;font-weight: bold;
    font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;">Capture The Campus</h1>

    <div id="startmenuobj" class= "startmenu" >
      
      <h1 style="color:rgb(255, 255, 255);text-align:center;line-height: 0.4em;width:100%;font-weight: bold;
    font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:5vw;">Capture The Campus</h1>

      <div class="row2">
		
        <div class="column2">
          
          <div class="button4" style="text-align:center;">
            <input id="notbutton" type="button" class="button3" style="text-align:center;width:80%;line-height: 0.2em;font-weight: bold;
            font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(184, 184, 184);" 
            value="Team Select" onclick="">
          </div>
          
          <div class="button4" style="text-align:center;">
          <input id="redbutton" type="button" class="button3" style="text-align:center;width:70%;line-height: 0.2em;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(255, 0, 0);" value="RedTeam" onclick="setredteam()">
           </div>
          
          <div class="button4" style="text-align:center;">
          <input id="bluebutton" type="button" class="button3" style="text-align:center;width:70%;line-height: 0.2em;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(4, 0, 255);" value="BlueTeam" onclick="setblueteam()">
           </div>

        </div>

        <div class="column2">

          <div class="button4" style="text-align:center;">
            <input id="notbutton2" type="button" class="button3" style="text-align:center;width:80%;line-height: 0.2em;font-weight: bold;
            font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(184, 184, 184);" 
            value="Class Select" onclick="">
          </div>
          
          <div class="button4" style="text-align:center;">
          <input id="knightbutton" type="button" class="button3" style="text-align:center;width:70%;line-height: 0.2em;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(160, 160, 160);" value="Knight Class" onclick="setclass(1)">
           </div>
          
          <div class="button4" style="text-align:center;">
          <input id="archerbutton" type="button" class="button3" style="text-align:center;width:70%;line-height: 0.2em;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(146, 58, 0);" value="Archer Class" onclick="setclass(2)">
           </div>

           <div class="button4" style="text-align:center;">
            <input id="healerbutton" type="button" class="button3" style="text-align:center;width:70%;line-height: 0.2em;font-weight: bold;
            font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(0, 180, 15);" value="Healer Class" onclick="setclass(3)">
             </div>
       
        </div>
      
      </div>
      
      <div class="lower1">
       <!-- 
        
        have a start game button that applys the player settings,
         and if none are selected then apply random
         , also maybe once the button is pressed 
      switch to a loading screen, then when the player is loaded show the map -->
      
      
        <input id="bluebutton" type="button" class="button3" style="text-align:center;width:70%;line-height: 0.2em;font-weight: bold;
        font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(184, 184, 184);color:rgb(0, 0, 0);"
         value="Start Game" onclick="closestartmenu()">
        
      

      </div>
    

    </div>

    <div id="loadingscreenobj" class= "loadingscreen" >
      
      

       <!--  have a start game button that applys the player settings,
         and if none are selected then apply random
         , also maybe once the button is pressed 
      switch to a loading screen, then when the player is loaded show the map -->
      

        <div  id="loadingtext" class="center" style="color:rgb(255, 255, 255);font-weight: bold;
       font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;">Loading...</div>

    </div>




    <!--  Main Site, to contain a welcome screen with an explination on how to play-->
    <div id="mainpage" style="background-color:rgb(0, 0, 0);border: 1px solid #000000 ">
      
      
      <div class="row">
		
        <div class="column">
          <!-- 
          <input id="redbutton" type="button" class="button" style="text-align:center;width:100%;line-height: 0.2em;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(255, 0, 0);" 
          value="RedTeam" onclick="setredteam()"> -->

          <div id="redbox" class="button" style="width:98%;background-color:rgb(255, 0, 0);">
            <div id="red" style="text-align:center;width:100%;height:100%;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:4vh;
          line-height: 1.2em;color:rgb(255, 255, 255);">
          Red: 0</div>

          </div>
        
        </div>
        <div class="column">
<!-- 
          <input id="bluebutton" type="button" class="button" style="text-align:center;width:100%;line-height: 0.2em;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:2.5vw;background-color:rgb(0, 0, 255);" 
          value="BlueTeam" onclick="setblueteam()">-->

          <div id="bluebox" class="button" style="width:98%;background-color:rgb(0, 0, 255);">
            <div id="blue" style="text-align:center;width:100%;height:100%;font-weight: bold;
          font-family:'Copperplate Gothic','Times New Roman', Times, serif;font-size:4vh;
          line-height: 1.2em;color:rgb(255, 255, 255);">
          Blue: 0</div>

          </div>
          
       
        </div>
      </div>
        

        
    </div>
    <!-- End Of Main Site -->

    <div id="map"><p id="demo" style="background-color:rgb(255, 255, 255);border: 5px solid #000000 "></p></div>

    

</body>
 
<script>
    
    var map;
    
    //for each team 
//red.innerHTML = "Red : " + team red score;
    

    var x = document.getElementById("demo");

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    
    function setLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPositionmap);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    function showPositionmap(position) {
      

      map = L.map('map').setView([position.coords.latitude, position.coords.longitude], 19);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
      
      }

    setLocation();
    


    var users = [];
    //create js objects to hold the marker, and other player info, this can then be used(with a check loop) to see if the 
    //player is still online, and so that the player can be moved

    var teams = [];
    var capturepoints = [];

//run every 1000 ms
//game loop 
setInterval(GameLoop, 1000);

//run it every 500ms
setInterval(AnimationLoop, 500);

var userid;
var username;
//var userlocation;
var userlocationlatitude;
var userlocationlongitude;
//[position.coords.latitude, position.coords.longitude]
var islocalplayerloaded = false;
var islocalplayerloadedi = 1;

var userteam = 0;

//0 player selects the nearest target
//1 auto selects the nearest target(not implemented)
var userabilitytargetnearest = 0;

var userabilitytarget = -1;

var userclass = 0;
var userprefsset = 0;
var newusertimeout = 6;

function AnimationLoop(){

  if(1 == 1){
      if(islocalplayerloadedi == 1){
        //document.getElementById("loadingtext").style.zindex = 0;
        loadingtext.innerHTML = "Loading.";
      }
      if(islocalplayerloadedi == 2){
        loadingtext.innerHTML = "Loading..";
      }
      if(islocalplayerloadedi == 3){
        loadingtext.innerHTML = "Loading...";
        islocalplayerloadedi = 0;
      }
      islocalplayerloadedi++;

  }

}

function GameLoop() {


  //first do the local player stuff
  if(1 == 1){

      //first fetch the local players location
      getLocation2();
      
      if(userid == null){
        //check for a cookie
        if(userprefsset != 0){
          var returncookieuserid = "";// = getCookie("userid");

          if(returncookieuserid == ""){
            //then send a load command to the server to get a user id and a player name
            if(newusertimeout > 3){
              loadnewuser();
              newusertimeout = 0;
            }
            newusertimeout++;
          
          }
          else{
            userid = returncookieuserid;
            username = "Player" . returncookieuserid;
          }
        }

        //the id and username should now be set either by the cookie or by getting a new userid

      }
      else{

        //if the user id isn't null then the local player can sent the id and location, to the server in order to update them on the server side
        setuserlocation();

        //setuserteam();

      }


  }

  
  

  //then do the external stuff
  //load the players onto the map
  //
  if(userprefsset != 0){
    

    //set a check for each user, so that it can be seen as offline if not updated
    users.forEach(user => {
      user.setcheck();
    });


    
    
    
    //get all the users and their locations, then load them onto the map
    


     loadgameinfo();


    if(islocalplayerloaded == true){
      closeloadingscreen();
    }
    else{
      
      
    }

//remove all the users from the map that are not on the location list

     users.forEach(user => {
      if(user.getcheck() >= 5){
         user.hideplayer(map);
      }
     
    });
  }

}





function loadgameinfo() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {loadgameinforeturn(this);}
  xhttp.open("GET", 'https://uniserver.ethanrws.com/getgameinfo.php');
  xhttp.send();
}

function loadgameinforeturn(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

      var lines = response.split(/\r?\n|\r|\n/g);
      //console.log(lines);    

      //used when loading the lines, to determine what is been loaded
      //and therefore where does the data need to go
      var linetype = 0;
             
      if(lines[0] != ""){

          for (i = 0; i < lines.length; i++) {
            var linetypechange = 0;
            if(lines[i] == "###teams"){
              //console.log(lines[i]);  
              //then set it to teams mode,
              //and continue until another modechange occurs
              linetype = 1;
              linetypechange = 1;
            }
            if(lines[i] == "###capturepoints"){
              //console.log(lines[i]);
              //then set it to capturepoints mode,
              //and continue until another modechange occurs
              linetype = 2;
              linetypechange = 1;
            }
            if(lines[i] == "###players"){
              //console.log(lines[i]);
              //then set it to players mode,
              //and continue until the end of the lines
              linetype = 3;
              linetypechange = 1;
            }

            //team mode
            if(linetype == 1 && linetypechange == 0){

              var line = lines[i].split('|');
              //console.log(lines[i]);
              var id = line[0];
              var teamname = line[1];
              var teamscore = line[2];
              var teamcapcount = line[3];

              var teamalreadyloaded = 0;

              if(teams.length != 0){

              
                teams.forEach(team => {
  
                  if(team.getid() == id){
                    teamalreadyloaded = 1;

                    team.setteamscore(teamscore);
                    team.setteamcapcount(teamcapcount);

                    if(id == 1){
                        //red team
                        red.innerHTML = "Red: " + teamscore;
                    }
                    if(id == 2){
                        //blue team
                        blue.innerHTML = "Blue: " + teamscore;
                    }
                    //document.getElementById("demo").style.color = "red"

                  }
                });

              }
  
              if(teamalreadyloaded == 0){
                var newteam = new TeamObject(id,teamname,teamscore,teamcapcount);
                teams.push(newteam);
              } 


            }

            //capture points mode
            if(linetype == 2 && linetypechange == 0){

              var line = lines[i].split('|');
              //console.log(lines[i]);
              var id = line[0];
              var capturepointname = line[1];

              var locationlat = line[2];
              var locationlong = line[3];

              var capturedteam = line[4];
              var capturedteamvalue = line[5];
              var radius = line[6];

              var capturepointalreadyloaded = 0;

              if(capturepoints.length != 0){
              capturepoints.forEach(capturepoint => {

                if(capturepoint.getid() == id){
                  capturepointalreadyloaded = 1;
                  //here will be where the map ref, and lat, long are passed
                  capturepoint.setcapturedteam(capturedteam);
                  capturepoint.setcapturedteamvalue(capturedteamvalue);
                  capturepoint.updateview();

                }
              });
            }

              if(capturepointalreadyloaded == 0){
                var newcapturepoint = new CapturePointObject(id,capturepointname,teamscore,teamcapcount,radius,map,locationlat,locationlong);
                capturepoints.push(newcapturepoint);
              } 


            }

            //player mode
            if(linetype == 3 && linetypechange == 0){

            
             var line = lines[i].split('|');
             //console.log(line);
             //console.log(lines[i]);
             var id = line[0];
             var playername = line[1];
             var locationlat = line[2];
             var locationlong = line[3];
             var playerteam = line[4];
             var playerhealth = line[5];
             var playerclass = line[6];

            //add health,(have a ghost mode
            //that shows other players as ghosts,)

            //also have the localplayer have a golden halo effect to 
            //show that it is the local player

             var playeralreadyloaded = 0;

            
             if(users.length != 0){
             users.forEach(user => {
               
                if(user.getid() == id){
                  playeralreadyloaded = 1;
                  user.resetcheck();
                  user.setteam(playerteam);
                  user.sethealth(playerhealth);
                  user.setclass(playerclass);

                  user.setlocation(map, locationlat,locationlong);
                }
          
              });
            }
               

              if(playeralreadyloaded == 0){

                var newuser = new PlayerObject(id,playername);

                newuser.setid(id);
                newuser.setplayername(playername);
                
                newuser.setteam(playerteam);
                newuser.sethealth(playerhealth);
                newuser.setclass(playerclass);
                newuser.setcheck(1);
                if(id == userid){
                      //then this is the local player
                      newuser.setlocalplayer(true);
                      islocalplayerloaded = true;
                }

                newuser.setlocation(map, locationlat,locationlong);

                users.push(newuser);
                
                
            }


            }



           }
       }
				
	}




function loadnewuser() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {loadnewuserreturn(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/createplayer.php?latitude=' + 0 + '&longitude=' + 0 +'');
  xhttp.send();
}

function loadnewuserreturn(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

      var lines = response.split(/\r?\n|\r|\n/g);
               // var lines = response.match(/[^\r\n]+/g);

               //console.log(lines[0]);
              if(lines[0] == "ok"){
                  userid = lines[1];
                 username = lines[2];

                 setuserteam();
                 
                 setuserclass();

                 //console.log("userid:" + userid);
                 //console.log("username:" + username);


                // setCookie("userid", userid, 365);
              }
              
				/*
      for (i = 0; i < lines.length; i++) {
      }
				*/	
	}


  function setuserlocation() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {setuserlocationreturn(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/updatelocation.php?id=' + userid + '&latitude=' + userlocationlatitude + '&longitude=' + userlocationlongitude +'');
  xhttp.send();
}

function setuserlocationreturn(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

	}


  function getLocation2() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition2);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    
    function showPosition2(position) {
      
      userlocationlatitude = position.coords.latitude;
      userlocationlongitude = position.coords.longitude;
        //console.log(userlocation);
    }


function setredteam(){
  if(userteam == 0){
    userteam = 1;
    //setuserteam();
    document.getElementById("redbutton").style.color = "white";
  } 
  else{
    userteam = 1;
    document.getElementById("redbutton").style.color = "white";
    document.getElementById("bluebutton").style.color = "black";
  }
}
function setblueteam(){
  if(userteam == 0){
    userteam = 2;
    //setuserteam();
    document.getElementById("bluebutton").style.color = "white";
  }
  else{
    userteam = 2;
    document.getElementById("redbutton").style.color = "black";
    document.getElementById("bluebutton").style.color = "white";
  }
}

function setclass(classset){
  if(userclass == 0){
    userclass = classset;
    
    if(classset == 1){
      document.getElementById("knightbutton").style.color = "white";
    }
    if(classset == 2){
      document.getElementById("archerbutton").style.color = "white";
    }
    if(classset == 3){
      document.getElementById("healerbutton").style.color = "white";
    }
    
  }
  else{
    document.getElementById("knightbutton").style.color = "black";
    document.getElementById("archerbutton").style.color = "black";
    document.getElementById("healerbutton").style.color = "black";

    userclass = classset;

    if(classset == 1){
      document.getElementById("knightbutton").style.color = "white";
    }
    if(classset == 2){
      document.getElementById("archerbutton").style.color = "white";
    }
    if(classset == 3){
      document.getElementById("healerbutton").style.color = "white";
    }


  }
}


function setplayerabilitytarget(pTargetId){
   //check to see if it is the local player, if it is do nothing
  if(pTargetId != userid){
      //console.log("Player" + pTargetId);

      
      //set the variable and then set the target variable in the player object so that it will show as the target
      //have it as a loop and reset any player that was previously the target
      users.forEach(user => {
        
        //then this is the new target, so check to see if it is a valid target
        if(user.getid() == pTargetId){

            if(user.getteam() == userteam){
                //then they are on the same team so check what kind of ability the player has
                //ie if healing then it will only work for players on the same team
                if(userclass == 3){
                    //then its a healer so set the player as the target
                    userabilitytarget = pTargetId;
                }  
            }
            else{
                if(userclass == 1){
                    //then its a knight so set the player as the target
                    userabilitytarget = pTargetId;
                }
                if(userclass == 2){
                    //then its a archer so set the player as the target
                    userabilitytarget = pTargetId;
                }
            }
        }  
      });  
  }

  //also then send the target info to the server(when loading have it set it to nearest player)
  setusertarget();
  
}

function setusertarget() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {setusertarget2(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/updateplayertarget.php?id=' + userid + '&target=' + userabilitytarget +'');
  xhttp.send();
}

function setusertarget2(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

	}

    function setuserteam() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {setuserteam2(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/updateteam.php?id=' + userid + '&team=' + userteam +'');
  xhttp.send();
}

function setuserteam2(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

	}

  function setuserclass() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {setuserclass2(this);}
  xhttp.open("POST", 'https://uniserver.ethanrws.com/updateclass.php?id=' + userid + '&class=' + userclass +'');
  xhttp.send();
}

function setuserclass2(xhttp) {
	    let response = xhttp.response;

      //console.log(response);

	}



  function closestartmenu() {
  if(userteam != 0 && userclass != 0){

    userprefsset = 1;

  }

  if(userprefsset == 1){


    //document.getElementById("startmenuobj").style.opacity = 0;
    document.getElementById("startmenuobj").style.zindex = 0;
    document.getElementById("startmenuobj").style.left=100 +'%';

  }
}

function closeloadingscreen() {

//document.getElementById("startmenuobj").style.opacity = 0;
document.getElementById("loadingscreenobj").style.zindex = 0;
document.getElementById("loadingscreenobj").style.left=100 +'%';

}


</script>


</html>